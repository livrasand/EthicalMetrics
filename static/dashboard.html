<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | EthicalMetrics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/livrasand/statix-ethicalMetrics-cdn@main/dashboard.css">
  <style>
    .chart-title {
      color: #fff;
    }
  </style>
</head>
<body>
  <nav class="nav-flotante">
    <div class="nav-contenido">
      <a href="/" class="nav-logo">
        <svg class="nav-logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L3 7L12 12L21 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 12L12 17L21 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 17L12 22L21 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        EthicalMetrics
      </a>
      
      
    </div>
  </nav>

  <main class="main-container type-heading-05 text-secondary quote" id="dashboardContent">
    <div class="dashboard-header">
      <div class="dashboard-title">
        <svg class="dashboard-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 3H10V10H3V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 3H21V10H14V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 14H10V21H3V14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 14H21V21H14V14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1 class="type-heading-05">Dashboard Analytics</h1>
      </div>
    </div>

    <div class="chart-grid">
      <!-- Uso por m√≥dulo -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Uso por m√≥dulo</h2>
        </div>
        <div class="chart-container">
          <canvas id="modulosChart"></canvas>
        </div>
      </div>

      <!-- Visitas por d√≠a -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Visitas por d√≠a</h2>
        </div>
        <div class="chart-container">
          <canvas id="visitasChart"></canvas>
        </div>
      </div>

      <!-- Usuarios activos en tiempo real -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Usuarios activos ahora</h2>
        </div>
        <div class="chart-container">
          <div id="usuariosActivos" class="stat-value">0</div>
          <div class="stat-label">En este momento</div>
        </div>
      </div>

      <!-- Dispositivos -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Dispositivos</h2>
        </div>
        <div class="chart-container">
          <canvas id="dispositivosChart"></canvas>
        </div>
      </div>

      <!-- Pa√≠ses/Lugares de visita -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Pa√≠ses</h2>
        </div>
        <div class="chart-container">
          <canvas id="paisesChart"></canvas>
        </div>
      </div>

      <!-- Navegadores -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Navegadores</h2>
        </div>
        <div class="chart-container">
          <canvas id="navegadoresChart"></canvas>
        </div>
      </div>

      <!-- Referencias -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Referencias</h2>
        </div>
        <div class="chart-container">
          <canvas id="referenciasChart"></canvas>
        </div>
      </div>

      <!-- P√°ginas m√°s vistas -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">P√°ginas m√°s vistas</h2>
        </div>
        <div class="chart-container">
          <canvas id="paginasChart"></canvas>
        </div>
      </div>

      <!-- Duraci√≥n media de sesi√≥n -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Duraci√≥n media de sesi√≥n</h2>
        </div>
        <div class="chart-container">
          <div id="duracionMedia" class="stat-value">0s</div>
          <div class="stat-label">Promedio</div>
        </div>
      </div>

      <!-- Idiomas del navegador -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Idiomas del navegador</h2>
        </div>
        <div class="chart-container">
          <canvas id="browserLangChart"></canvas>
        </div>
      </div>

      <!-- Sistemas operativos -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Sistemas operativos</h2>
        </div>
        <div class="chart-container">
          <canvas id="osChart"></canvas>
        </div>
      </div>

      <!-- Ciudades -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Ciudades</h2>
        </div>
        <div class="chart-container">
          <canvas id="cityChart"></canvas>
        </div>
      </div>

      <!-- Comparativas temporales -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Comparativa semanal</h2>
        </div>
        <div class="chart-container">
          <canvas id="weekCompareChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Comparativa mensual</h2>
        </div>
        <div class="chart-container">
          <canvas id="monthCompareChart"></canvas>
        </div>
      </div>
      <!-- Retenci√≥n -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Retenci√≥n (global/p√°gina)</h2>
        </div>
        <div class="chart-container">
          <canvas id="retentionChart"></canvas>
        </div>
      </div>
      <!-- Funnel b√°sico -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Funnel b√°sico</h2>
        </div>
        <div class="chart-container">
          <canvas id="funnelChart"></canvas>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer-flotante">
    <div class="footer-contenido">
      <span class="footer-texto type-mono-01">¬© 2025-PRESENT EthicalMetrics OSS</span>
      <div class="footer-enlaces">
        <a href="/privacy" class="footer-link type-mono-01">Privacidad</a>
        <a href="/terms" class="footer-link type-mono-01">T√©rminos</a>
        <a href="/docs" class="footer-link type-mono-01">Documentaci√≥n</a>
        <a href="" class="footer-link type-mono-01">Soporte</a>
      </div>
    </div>
  </footer>

  <!--script src="https://cdn.jsdelivr.net/gh/livrasand/statix-ethicalMetrics-cdn@v1.3.0/dashboard.js" defer></script-->
  <script src="https://cdn.jsdelivr.net/gh/livrasand/statix-ethicalMetrics-cdn@v1.2.0/global-design.js" defer></script>
  <script>
    let isLoading = false;
    const charts = {};

    const urlParams = new URLSearchParams(window.location.search);
    const site = urlParams.get("site");
    const token = urlParams.get("token");

    if (!site || !token) {
      document.body.innerHTML = "<h2>üîí Acceso denegado</h2>";
    } else {
      cargarDatos(site, token);
    }

    async function cargarDatos(site, token) {
      if (isLoading) return;
      isLoading = true;
      try {
        const res = await fetch(`/stats?site=${site}&token=${token}`);
        if (!res.ok) {
          document.body.innerHTML = "<h2>üîí Acceso denegado o inv√°lido</h2>";
          return;
        }

        const data = await res.json();
        console.log("Datos recibidos:", data);

        const porModulo = Array.isArray(data.por_modulo) ? data.por_modulo : [];
        const porDia = Array.isArray(data.por_dia) ? data.por_dia : [];
        const navegadores = Array.isArray(data.navegadores) ? data.navegadores : [];
        const referencias = Array.isArray(data.referencias) ? data.referencias : [];
        const paginas = Array.isArray(data.paginas) ? data.paginas : [];
        const duracionMedia = data.duracion_media || 0;
        const browserLangs = Array.isArray(data.browser_langs) ? data.browser_langs : [];
        const osArr = Array.isArray(data.os) ? data.os : [];
        const cities = Array.isArray(data.cities) ? data.cities : [];

        const modulosCanvas = document.getElementById("modulosChart");
if (modulosCanvas) {
  if (charts.modulosChart) charts.modulosChart.destroy();
  charts.modulosChart = new Chart(modulosCanvas, {
    type: 'bar',
    data: {
      labels: porModulo.map(d => d.modulo),
      datasets: [{
        label: 'Usos por m√≥dulo',
        data: porModulo.map(d => d.total),
        backgroundColor: '#3cbf8e'
      }]
    }
  });
}

    if (charts.visitasChart) charts.visitasChart.destroy();
    charts.visitasChart = new Chart(document.getElementById("visitasChart"), {
      type: 'line',
      data: {
        labels: porDia.map(d => d.dia),
        datasets: [{
          label: 'Visitas por d√≠a',
          data: porDia.map(d => d.total),
          borderColor: '#846bff',
          fill: false
        }]
      }
    });

    // Navegadores
    if (charts.navegadoresChart) charts.navegadoresChart.destroy();
    charts.navegadoresChart = new Chart(document.getElementById("navegadoresChart"), {
      type: 'doughnut',
      data: {
        labels: navegadores.map(d => d.navegador),
        datasets: [{
          label: 'Navegadores',
          data: navegadores.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623', '#e94e77', '#4a90e2']
        }]
      }
    });

    // Referencias
    if (charts.referenciasChart) charts.referenciasChart.destroy();
    charts.referenciasChart = new Chart(document.getElementById("referenciasChart"), {
      type: 'pie',
      data: {
        labels: referencias.map(d => d.referencia),
        datasets: [{
          label: 'Referencias',
          data: referencias.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623', '#e94e77', '#4a90e2']
        }]
      }
    });

    // P√°ginas m√°s vistas
    if (charts.paginasChart) charts.paginasChart.destroy();
    charts.paginasChart = new Chart(document.getElementById("paginasChart"), {
      type: 'bar',
      data: {
        labels: paginas.map(d => d.pagina),
        datasets: [{
          label: 'P√°ginas m√°s vistas',
          data: paginas.map(d => d.total),
          backgroundColor: '#4a90e2'
        }]
      }
    });

    // Duraci√≥n media de sesi√≥n
    const duracionDiv = document.getElementById("duracionMedia");
    if (duracionDiv) {
      const segundos = Math.round(duracionMedia / 1000);
      duracionDiv.textContent = segundos + 's';
    }

    // Dispositivos
    const dispositivos = Array.isArray(data.dispositivos) ? data.dispositivos : [];
    if (charts.dispositivosChart) charts.dispositivosChart.destroy();
    charts.dispositivosChart = new Chart(document.getElementById("dispositivosChart"), {
      type: 'doughnut',
      data: {
        labels: dispositivos.map(d => d.dispositivo),
        datasets: [{
          label: 'Dispositivos',
          data: dispositivos.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623']
        }]
      }
    });

    // Pa√≠ses
    const paises = Array.isArray(data.paises) ? data.paises : [];
    if (charts.paisesChart) charts.paisesChart.destroy();
    charts.paisesChart = new Chart(document.getElementById("paisesChart"), {
      type: 'pie',
      data: {
        labels: paises.map(d => d.pais),
        datasets: [{
          label: 'Pa√≠ses',
          data: paises.map(d => d.total),
          backgroundColor: ['#4a90e2', '#3cbf8e', '#f5a623', '#e94e77', '#1a2330']
        }]
      }
    });

    // Usuarios activos
    const usuariosActivos = typeof data.usuarios_activos === "number" ? data.usuarios_activos : 0;
    const usuariosActivosDiv = document.getElementById("usuariosActivos");
    if (usuariosActivosDiv) {
      usuariosActivosDiv.textContent = usuariosActivos;
    }

    // Idiomas del navegador
    if (charts.browserLangChart) charts.browserLangChart.destroy();
    charts.browserLangChart = new Chart(document.getElementById("browserLangChart"), {
      type: 'pie',
      data: {
        labels: browserLangs.map(d => d.lang),
        datasets: [{
          label: 'Idiomas',
          data: browserLangs.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623', '#e94e77', '#4a90e2']
        }]
      }
    });

    // Sistemas operativos
    if (charts.osChart) charts.osChart.destroy();
    charts.osChart = new Chart(document.getElementById("osChart"), {
      type: 'doughnut',
      data: {
        labels: osArr.map(d => d.os),
        datasets: [{
          label: 'Sistemas operativos',
          data: osArr.map(d => d.total),
          backgroundColor: ['#4a90e2', '#3cbf8e', '#f5a623', '#e94e77', '#1a2330']
        }]
      }
    });

    // Ciudades
    if (charts.cityChart) charts.cityChart.destroy();
    charts.cityChart = new Chart(document.getElementById("cityChart"), {
      type: 'bar',
      data: {
        labels: cities.map(d => d.city),
        datasets: [{
          label: 'Ciudades',
          data: cities.map(d => d.total),
          backgroundColor: '#846bff'
        }]
      }
    });

    // Comparativa semanal
    if (Array.isArray(data.week_compare) && document.getElementById("weekCompareChart")) {
      if (charts.weekCompareChart) charts.weekCompareChart.destroy();
      charts.weekCompareChart = new Chart(document.getElementById("weekCompareChart"), {
        type: 'line',
        data: {
          labels: data.week_compare.map(d => d.label),
          datasets: [
            { label: 'Semana actual', data: data.week_compare.map(d => d.current), borderColor: '#3cbf8e', fill: false },
            { label: 'Semana pasada', data: data.week_compare.map(d => d.previous), borderColor: '#e94e77', fill: false }
          ]
        }
      });
    }

    // Comparativa mensual
    if (Array.isArray(data.month_compare) && document.getElementById("monthCompareChart")) {
      if (charts.monthCompareChart) charts.monthCompareChart.destroy();
      charts.monthCompareChart = new Chart(document.getElementById("monthCompareChart"), {
        type: 'line',
        data: {
          labels: data.month_compare.map(d => d.label),
          datasets: [
            { label: 'Mes actual', data: data.month_compare.map(d => d.current), borderColor: '#4a90e2', fill: false },
            { label: 'Mes pasado', data: data.month_compare.map(d => d.previous), borderColor: '#f5a623', fill: false }
          ]
        }
      });
    }

    // Retenci√≥n
    if (Array.isArray(data.retention) && document.getElementById("retentionChart")) {
      if (charts.retentionChart) charts.retentionChart.destroy();
      charts.retentionChart = new Chart(document.getElementById("retentionChart"), {
        type: 'bar',
        data: {
          labels: data.retention.map(d => d.label),
          datasets: [{
            label: 'Retenci√≥n (%)',
            data: data.retention.map(d => d.value),
            backgroundColor: '#846bff'
          }]
        }
      });
    }

    // Funnel b√°sico
    if (Array.isArray(data.funnel) && document.getElementById("funnelChart")) {
      if (charts.funnelChart) charts.funnelChart.destroy();
      charts.funnelChart = new Chart(document.getElementById("funnelChart"), {
        type: 'bar',
        data: {
          labels: data.funnel.map(d => d.step),
          datasets: [{
            label: 'Usuarios',
            data: data.funnel.map(d => d.value),
            backgroundColor: '#3cbf8e'
          }]
        }
      });
    }

  } catch (e) {
    console.error("‚ùå Error en fetch:", e);
    document.body.innerHTML = "<h2>‚ùå Error de conexi√≥n</h2>";
  } finally {
    isLoading = false;
  }
}
  </script>
</body>
</html>