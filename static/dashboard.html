<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | EthicalMetrics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/livrasand/statix-ethicalMetrics-cdn@main/dashboard.css">
  <style>
    .chart-title {
      color: #fff;
    }
  </style>
</head>
<body>
  <nav class="nav-flotante">
    <div class="nav-contenido">
      <a href="/" class="nav-logo">
        <svg class="nav-logo-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L3 7L12 12L21 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 12L12 17L21 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 17L12 22L21 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        EthicalMetrics
      </a>
      
      
    </div>
  </nav>

  <main class="main-container type-heading-05 text-secondary quote" id="dashboardContent">
    <div class="dashboard-header">
      <div class="dashboard-title">
        <svg class="dashboard-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 3H10V10H3V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 3H21V10H14V3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 14H10V21H3V14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14 14H21V21H14V14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h1 class="type-heading-05">Dashboard Analytics</h1>
      </div>
    </div>

    <div class="chart-grid">
      <!-- Uso por módulo -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Uso por módulo</h2>
        </div>
        <div class="chart-container">
          <canvas id="modulosChart"></canvas>
        </div>
      </div>

      <!-- Visitas por día -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Visitas por día</h2>
        </div>
        <div class="chart-container">
          <canvas id="visitasChart"></canvas>
        </div>
      </div>

      <!-- Usuarios activos en tiempo real -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Usuarios activos ahora</h2>
        </div>
        <div class="chart-container">
          <div id="usuariosActivos" class="stat-value">0</div>
          <div class="stat-label">En este momento</div>
        </div>
      </div>

      <!-- Dispositivos -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Dispositivos</h2>
        </div>
        <div class="chart-container">
          <canvas id="dispositivosChart"></canvas>
        </div>
      </div>

      <!-- Países/Lugares de visita -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Países</h2>
        </div>
        <div class="chart-container">
          <canvas id="paisesChart"></canvas>
        </div>
      </div>

      <!-- Navegadores -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Navegadores</h2>
        </div>
        <div class="chart-container">
          <canvas id="navegadoresChart"></canvas>
        </div>
      </div>

      <!-- Referencias -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Referencias</h2>
        </div>
        <div class="chart-container">
          <canvas id="referenciasChart"></canvas>
        </div>
      </div>

      <!-- Páginas más vistas -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Páginas más vistas</h2>
        </div>
        <div class="chart-container">
          <canvas id="paginasChart"></canvas>
        </div>
      </div>

      <!-- Duración media de sesión -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Duración media de sesión</h2>
        </div>
        <div class="chart-container">
          <div id="duracionMedia" class="stat-value">0s</div>
          <div class="stat-label">Promedio</div>
        </div>
      </div>

      <!-- Idiomas del navegador -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Idiomas del navegador</h2>
        </div>
        <div class="chart-container">
          <canvas id="browserLangChart"></canvas>
        </div>
      </div>

      <!-- Sistemas operativos -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Sistemas operativos</h2>
        </div>
        <div class="chart-container">
          <canvas id="osChart"></canvas>
        </div>
      </div>

      <!-- Ciudades -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Ciudades</h2>
        </div>
        <div class="chart-container">
          <canvas id="cityChart"></canvas>
        </div>
      </div>

      <!-- Comparativas temporales -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Comparativa semanal</h2>
        </div>
        <div class="chart-container">
          <canvas id="weekCompareChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Comparativa mensual</h2>
        </div>
        <div class="chart-container">
          <canvas id="monthCompareChart"></canvas>
        </div>
      </div>
      <!-- Retención -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Retención (global/página)</h2>
        </div>
        <div class="chart-container">
          <canvas id="retentionChart"></canvas>
        </div>
      </div>
      <!-- Funnel básico -->
      <div class="chart-card">
        <div class="chart-header">
          <h2 class="chart-title">Funnel básico</h2>
        </div>
        <div class="chart-container">
          <canvas id="funnelChart"></canvas>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer-flotante" id="footerFlotante">
    <button class="footer-toggle" aria-label="Mostrar/Ocultar footer" aria-expanded="false">
      <span class="footer-toggle-bar"></span>
      <span class="footer-toggle-bar"></span>
      <span class="footer-toggle-bar"></span>
    </button>
    <div class="footer-contenido">
      <div class="footer-main-row">
        <span class="footer-texto type-mono-01">
          Maintained by <a href="https://github.com/livrasand" class="text-accent">@livrasand</a> and 
          <a href="https://github.com/livrasand/EthicalMetrics/graphs/contributors">contributors</a>
          <br>
          © 2025-PRESENT EthicalMetrics OSS
        </span>
        <div class="footer-enlaces">
          <a href="/about" class="footer-link type-mono-01"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="m10.065 12.493l-6.18 1.318a.934.934 0 0 1-1.108-.702l-.537-2.15a1.07 1.07 0 0 1 .691-1.265l13.504-4.44m-2.875 6.493l4.332-.924M16 21l-3.105-6.21"/><path d="M16.485 5.94a2 2 0 0 1 1.455-2.425l1.09-.272a1 1 0 0 1 1.212.727l1.515 6.06a1 1 0 0 1-.727 1.213l-1.09.272a2 2 0 0 1-2.425-1.455zM6.158 8.633l1.114 4.456M8 21l3.105-6.21"/><circle cx="12" cy="13" r="2"/></g></svg> About</a>
          <a href="/privacy" class="footer-link type-mono-01"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2a10 10 0 1 0 10 10a4 4 0 0 1-5-5a4 4 0 0 1-5-5M8.5 8.5v.01M16 15.5v.01M12 12v.01M11 17v.01M7 14v.01"/></svg> Privacy</a>
          <a href="/terms" class="footer-link type-mono-01"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m16 16l3-8l3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1M2 16l3-8l3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1m5 5h10M12 3v18M3 7h2c2 0 5-1 7-2c2 1 5 2 7 2h2"/></svg> Terms</a>
          <a href="/security" class="footer-link type-mono-01"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1zM8 12h.01M12 12h.01M16 12h.01"/></svg> Security</a>
          <a href="https://deepwiki.com/livrasand/EthicalMetrics" class="footer-link type-mono-01"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 7v14m4-9h2m-2-4h2M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4a4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3a3 3 0 0 0-3-3zm3-6h2M6 8h2"/></svg> Docs</a>
          <a href="https://github.com/livrasand/EthicalMetrics/issues" class="footer-link type-mono-01"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3m.08 4h.01"/></g></svg> Soporte</a>
        </div>
      </div>
    </div>
    <style>
      .footer-flotante {
        width: 100%;
        border-top: 1px solid rgba(255,255,255,0.06);
        padding: 2em 0 1.2em 0;
        color: #E7DBFF;
        background: transparent;
      }
      .footer-toggle {
        display: none;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: -1.5em;
        background: #18132a;
        border: 1px solid #A47CFF;
        border-radius: 1.5em;
        padding: 0.4em 1.2em;
        color: #A47CFF;
        cursor: pointer;
        z-index: 300;
        align-items: center;
        gap: 0.5em;
        font-size: 1em;
        transition: background 0.2s, color 0.2s;
      }
      .footer-toggle-bar {
        display: inline-block;
        width: 1.2em;
        height: 1px;
        background: #A47CFF;
        margin: 0 0.1em;
        border-radius: 0;
        vertical-align: middle;
      }
      .footer-toggle-label {
        margin-left: 0.5em;
        font-size: 1em;
        font-family: inherit;
        color: #A47CFF;
      }
      .footer-flotante.closed .footer-contenido {
        display: none;
      }
      @media (max-width: 700px) {
        .footer-flotante {
          padding: 0.5em 0 0.5em 0;
          background: #18132a;
        }
        .footer-toggle {
          display: flex;
        }
        .footer-contenido {
          transition: max-height 0.3s, opacity 0.3s;
          max-height: 1000px;
          opacity: 1;
        }
        .footer-flotante.closed .footer-contenido {
          max-height: 0;
          opacity: 0;
          overflow: hidden;
          padding: 0;
        }
      }
      .footer-contenido {
        max-width: 1100px;
        padding: 0 1.5em;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .footer-main-row {
        width: 100%;
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        gap: 2em;
        flex-wrap: wrap;
      }
      .footer-texto {
        flex: 1 1 320px;
        line-height: 1.7;
        color: #B9B4D9;
        min-width: 220px;
      }
      .footer-texto a {
        color: #A47CFF;
        text-decoration: underline dotted;
        transition: color 0.2s;
      }
      .footer-texto a:hover {
        color: #59FFA4;
      }
      .footer-enlaces {
        display: flex;
        flex-wrap: wrap;
        gap: 0.7em 1.5em;
        align-items: flex-start;
        justify-content: flex-end;
        min-width: 220px;
      }
      .footer-link {
        color: #E7DBFF;
        text-decoration: none;
        padding: 0.2em 0;
        border-bottom: 1.5px solid transparent;
        transition: color 0.2s, border-bottom 0.2s;
      }
      .footer-link:hover {
        color: #59FFA4;
        border-bottom: 1.5px solid #59FFA4;
      }
      @media (max-width: 800px) {
        .footer-enlaces {
          justify-content: flex-start;
        }
      }
      @media (max-width: 500px) {
        .footer-contenido {
          padding: 0 0.7em;
        }
        .footer-enlaces {
          gap: 0.5em 1em;
        }
      }
    </style>
    <script>
      (function() {
        var footer = document.getElementById('footerFlotante');
        var toggle = footer.querySelector('.footer-toggle');
        function setClosed(closed) {
          if (closed) {
            footer.classList.add('closed');
            toggle.setAttribute('aria-expanded', 'false');
          } else {
            footer.classList.remove('closed');
            toggle.setAttribute('aria-expanded', 'true');
          }
        }
        // Start closed on mobile
        function checkMobile() {
          if (window.innerWidth <= 700) {
            setClosed(true);
          } else {
            setClosed(false);
          }
        }
        toggle.addEventListener('click', function(e) {
          e.stopPropagation();
          var isClosed = footer.classList.contains('closed');
          setClosed(!isClosed);
        });
        window.addEventListener('resize', checkMobile);
        document.addEventListener('DOMContentLoaded', checkMobile);
      })();
    </script>
  </footer>

  <!--script src="https://cdn.jsdelivr.net/gh/livrasand/statix-ethicalMetrics-cdn@v1.3.0/dashboard.js" defer></script-->
  <script src="https://cdn.jsdelivr.net/gh/livrasand/statix-ethicalMetrics-cdn@v1.2.0/global-design.js" defer></script>
  <script>
    let isLoading = false;
    const charts = {};

    const urlParams = new URLSearchParams(window.location.search);
    const site = urlParams.get("site");
    const token = urlParams.get("token");

    if (!site || !token) {
      document.body.innerHTML = "<h2>🔒 Acceso denegado</h2>";
    } else {
      cargarDatos(site, token);
    }

    async function cargarDatos(site, token) {
      if (isLoading) return;
      isLoading = true;
      try {
        const res = await fetch(`/stats?site=${site}&token=${token}`);
        if (!res.ok) {
          document.body.innerHTML = "<h2>🔒 Acceso denegado o inválido</h2>";
          return;
        }

        const data = await res.json();
        console.log("Datos recibidos:", data);

        // Reemplazar el título por el nombre del sitio
        if (data.site_name) {
          const h1 = document.querySelector('.dashboard-title h1');
          if (h1) h1.textContent = data.site_name;
        }

        const porModulo = Array.isArray(data.por_modulo) ? data.por_modulo : [];
        const porDia = Array.isArray(data.por_dia) ? data.por_dia : [];
        const navegadores = Array.isArray(data.navegadores) ? data.navegadores : [];
        const referencias = Array.isArray(data.referencias) ? data.referencias : [];
        const paginas = Array.isArray(data.paginas) ? data.paginas : [];
        const duracionMedia = data.duracion_media || 0;
        const browserLangs = Array.isArray(data.browser_langs) ? data.browser_langs : [];
        const osArr = Array.isArray(data.os) ? data.os : [];
        const cities = Array.isArray(data.cities) ? data.cities : [];

        const modulosCanvas = document.getElementById("modulosChart");
if (modulosCanvas) {
  if (charts.modulosChart) charts.modulosChart.destroy();
  charts.modulosChart = new Chart(modulosCanvas, {
    type: 'bar',
    data: {
      labels: porModulo.map(d => d.modulo),
      datasets: [{
        label: 'Usos por módulo',
        data: porModulo.map(d => d.total),
        backgroundColor: '#3cbf8e'
      }]
    }
  });
}

    if (charts.visitasChart) charts.visitasChart.destroy();
    charts.visitasChart = new Chart(document.getElementById("visitasChart"), {
      type: 'line',
      data: {
        labels: porDia.map(d => d.dia),
        datasets: [{
          label: 'Visitas por día',
          data: porDia.map(d => d.total),
          borderColor: '#846bff',
          fill: false
        }]
      }
    });

    // Navegadores
    if (charts.navegadoresChart) charts.navegadoresChart.destroy();
    charts.navegadoresChart = new Chart(document.getElementById("navegadoresChart"), {
      type: 'doughnut',
      data: {
        labels: navegadores.map(d => d.navegador),
        datasets: [{
          label: 'Navegadores',
          data: navegadores.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623', '#e94e77', '#4a90e2']
        }]
      }
    });

    // Referencias
    if (charts.referenciasChart) charts.referenciasChart.destroy();
    charts.referenciasChart = new Chart(document.getElementById("referenciasChart"), {
      type: 'pie',
      data: {
        labels: referencias.map(d => d.referencia),
        datasets: [{
          label: 'Referencias',
          data: referencias.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623', '#e94e77', '#4a90e2']
        }]
      }
    });

    // Páginas más vistas
    if (charts.paginasChart) charts.paginasChart.destroy();
    charts.paginasChart = new Chart(document.getElementById("paginasChart"), {
      type: 'bar',
      data: {
        labels: paginas.map(d => d.pagina),
        datasets: [{
          label: 'Páginas más vistas',
          data: paginas.map(d => d.total),
          backgroundColor: '#4a90e2'
        }]
      }
    });

    // Duración media de sesión
    const duracionDiv = document.getElementById("duracionMedia");
    if (duracionDiv) {
      const segundos = Math.round(duracionMedia / 1000);
      duracionDiv.textContent = segundos + 's';
    }

    // Dispositivos
    const dispositivos = Array.isArray(data.dispositivos) ? data.dispositivos : [];
    if (charts.dispositivosChart) charts.dispositivosChart.destroy();
    charts.dispositivosChart = new Chart(document.getElementById("dispositivosChart"), {
      type: 'doughnut',
      data: {
        labels: dispositivos.map(d => d.dispositivo),
        datasets: [{
          label: 'Dispositivos',
          data: dispositivos.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623']
        }]
      }
    });

    // Países
    const paises = Array.isArray(data.paises) ? data.paises : [];
    if (charts.paisesChart) charts.paisesChart.destroy();
    charts.paisesChart = new Chart(document.getElementById("paisesChart"), {
      type: 'pie',
      data: {
        labels: paises.map(d => d.pais),
        datasets: [{
          label: 'Países',
          data: paises.map(d => d.total),
          backgroundColor: ['#4a90e2', '#3cbf8e', '#f5a623', '#e94e77', '#1a2330']
        }]
      }
    });

    // Usuarios activos
    const usuariosActivos = typeof data.usuarios_activos === "number" ? data.usuarios_activos : 0;
    const usuariosActivosDiv = document.getElementById("usuariosActivos");
    if (usuariosActivosDiv) {
      usuariosActivosDiv.textContent = usuariosActivos;
    }

    // Idiomas del navegador
    if (charts.browserLangChart) charts.browserLangChart.destroy();
    charts.browserLangChart = new Chart(document.getElementById("browserLangChart"), {
      type: 'pie',
      data: {
        labels: browserLangs.map(d => d.lang),
        datasets: [{
          label: 'Idiomas',
          data: browserLangs.map(d => d.total),
          backgroundColor: ['#3cbf8e', '#1a2330', '#f5a623', '#e94e77', '#4a90e2']
        }]
      }
    });

    // Sistemas operativos
    if (charts.osChart) charts.osChart.destroy();
    charts.osChart = new Chart(document.getElementById("osChart"), {
      type: 'doughnut',
      data: {
        labels: osArr.map(d => d.os),
        datasets: [{
          label: 'Sistemas operativos',
          data: osArr.map(d => d.total),
          backgroundColor: ['#4a90e2', '#3cbf8e', '#f5a623', '#e94e77', '#1a2330']
        }]
      }
    });

    // Ciudades
    if (charts.cityChart) charts.cityChart.destroy();
    charts.cityChart = new Chart(document.getElementById("cityChart"), {
      type: 'bar',
      data: {
        labels: cities.map(d => d.city),
        datasets: [{
          label: 'Ciudades',
          data: cities.map(d => d.total),
          backgroundColor: '#846bff'
        }]
      }
    });

    // Comparativa semanal
    if (Array.isArray(data.week_compare) && document.getElementById("weekCompareChart")) {
      if (charts.weekCompareChart) charts.weekCompareChart.destroy();
      charts.weekCompareChart = new Chart(document.getElementById("weekCompareChart"), {
        type: 'line',
        data: {
          labels: data.week_compare.map(d => d.label),
          datasets: [
            { label: 'Semana actual', data: data.week_compare.map(d => d.current), borderColor: '#3cbf8e', fill: false },
            { label: 'Semana pasada', data: data.week_compare.map(d => d.previous), borderColor: '#e94e77', fill: false }
          ]
        }
      });
    }

    // Comparativa mensual
    if (Array.isArray(data.month_compare) && document.getElementById("monthCompareChart")) {
      if (charts.monthCompareChart) charts.monthCompareChart.destroy();
      charts.monthCompareChart = new Chart(document.getElementById("monthCompareChart"), {
        type: 'line',
        data: {
          labels: data.month_compare.map(d => d.label),
          datasets: [
            { label: 'Mes actual', data: data.month_compare.map(d => d.current), borderColor: '#4a90e2', fill: false },
            { label: 'Mes pasado', data: data.month_compare.map(d => d.previous), borderColor: '#f5a623', fill: false }
          ]
        }
      });
    }

    // Retención
    if (Array.isArray(data.retention) && document.getElementById("retentionChart")) {
      if (charts.retentionChart) charts.retentionChart.destroy();
      charts.retentionChart = new Chart(document.getElementById("retentionChart"), {
        type: 'bar',
        data: {
          labels: data.retention.map(d => d.label),
          datasets: [{
            label: 'Retención (%)',
            data: data.retention.map(d => d.value),
            backgroundColor: '#846bff'
          }]
        }
      });
    }

    // Funnel básico
    if (Array.isArray(data.funnel) && document.getElementById("funnelChart")) {
      if (charts.funnelChart) charts.funnelChart.destroy();
      charts.funnelChart = new Chart(document.getElementById("funnelChart"), {
        type: 'bar',
        data: {
          labels: data.funnel.map(d => d.step),
          datasets: [{
            label: 'Usuarios',
            data: data.funnel.map(d => d.value),
            backgroundColor: '#3cbf8e'
          }]
        }
      });
    }

  } catch (e) {
    console.error("❌ Error en fetch:", e);
    document.body.innerHTML = "<h2>❌ Error de conexión</h2>";
  } finally {
    isLoading = false;
  }
}
  </script>
</body>
</html>